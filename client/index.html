<!-- ПОКА ЧТО ПРОСТО HIML СТРАНИЦА, ДЕЙСТВИЯ ПОЛЬЗОВАТЕЛЯ НЕ РАБОТАЮТ -->
<!DOCTYPE html>  <!-- -->
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title> Онлайн журнал для вузов </title>
    <script src="https://st.max.ru/js/max-web-app.js"></script>
    <link rel="stylesheet" href="https://st.max.ru/css/max-ui.css">

    <style>
        body {
            background: #f5f6fa;
            font-family: 'Arial', sans-serif;
        }
        .max-container {
            max-width: 600px;
            margin: 30px auto;
        }
        .max-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .max-step {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .hidden { display: none; }
    </style>

</head>
<body>
    <div class="max-container">
        <div class="max-header">
            <h1> Электронный журнал </h1>
            <p> Система учёта посещаемости вуза </p>
        </div>

        <!-- Шаг 1: ВУЗ -->
        <div id="step1" class="max-step">
            <div class="max-form-group">
                <label class="max-label" for="university">Выберите ваш вуз:</label>
                <select class="max-select" id="university">
                    <option value="">-- Выберите вуз --</option>
                    <option value="msu">МГУ им. М.В. Ломоносова</option>
                    <option value="mpei">МЭИ</option>
                    <option value="mipt">МФТИ</option>
                </select>
            </div>
            <button class="max-button primary" onclick="nextStep(2)">Далее</button>
        </div>
    
        <!-- Шаг 2: Роль -->
        <div id="step2" class="max-step hidden">
            <div class="max-form-group">
                <label class="max-label" for="role">Выберите вашу роль:</label>
                <select class="max-select" id="role" onchange="loadGroups()">
                    <option value="">-- Выберите роль --</option>
                    <option value="student">Студент</option>
                    <option value="teacher">Преподаватель</option>
                    <option value="headman">Староста</option>
                </select>
            </div>
    
            <div class="max-form-group hidden" id="groupSection">
                <label class="max-label" for="group">Выберите группу:</label>
                <select class="max-select" id="group"></select>
            </div>
    
            <button class="max-button primary" onclick="completeRegistration()">Завершить регистрацию</button>
            <button class="max-button secondary" onclick="prevStep(1)">Назад</button>
        </div>
    
        <!-- Шаг 3: Завершение -->
        <div id="step3" class="max-step hidden">
            <div class="max-card">
                <div class="max-card-header">
                    <h3>✅ Регистрация завершена</h3>
                </div>
                <div class="max-card-content" id="userInfo"></div>
            </div>
            <button class="max-button primary" onclick="enterSystem()">Войти в систему</button>
        </div>
    
        <div id="error" style="color:red; margin-top:15px;"></div>
    </div>

    <script> 
        const SERVER_URL = "http://127.0.0.1:8000"; //адрес в корень 
        let userData = {};
    
        function nextStep(step) {
            document.querySelectorAll('.max-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
        }
    
        function prevStep(step) {
            document.querySelectorAll('.max-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
        }
    
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                MaxWebApp.ready();
                const initData = MaxWebApp.initDataUnsafe;
    
                if (!initData || !initData.user) {
                    document.getElementById("error").innerText = "Не удалось получить данные пользователя из MAX.";
                    return;
                }
    
                const user = initData.user;
                const query_id = initData.query_id || "unknown";
    
                userData = {
                    query_id,
                    user_id: user.id,
                    name: user.first_name,
                    surname: user.last_name
                };
    
                // Проверяем регистрацию
                const checkResponse = await fetch(`${SERVER_URL}/auth/check_user?query_id=${query_id}`); //эндпоинт на роутере auth на сервере
                const checkData = await checkResponse.json();
    
                if (checkData.registered) {
                    document.getElementById("userInfo").innerHTML = `
                        <p><b>${user.first_name} ${user.last_name}</b></p>
                        <p>Вы уже зарегистрированы.</p>`;
                    nextStep(3);
                } else {
                    await fetch(`${SERVER_URL}/auth/register`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(userData)
                    });
                }
    
            } catch (err) {
                console.error(err);
                document.getElementById("error").innerText = "Ошибка при инициализации приложения.";
            }
        });
    
        async function loadGroups() {
            const role = document.getElementById("role").value;
            const univer = document.getElementById("university").value;
    
            if (!role || !univer) return;
    
            const groupSection = document.getElementById("groupSection");
            const groupSelect = document.getElementById("group");
            groupSection.classList.remove("hidden");
    
            // Загружаем список групп с сервера
            const response = await fetch(`${SERVER_URL}/auth/get_groups?role=${role}&univer=${univer}`);
            const data = await response.json();
    
            groupSelect.innerHTML = "";
            data.groups.forEach(g => {
                const opt = document.createElement("option");
                opt.value = g.id;
                opt.textContent = g.number;
                groupSelect.appendChild(opt);
            });
        }
    
        async function completeRegistration() {
            const univer = document.getElementById("university").value;
            const role = document.getElementById("role").value;
            const group_id = document.getElementById("group").value;
    
            if (!univer || !role) {
                document.getElementById("error").innerText = "Выберите все данные.";
                return;
            }
    
            userData.univer = univer;
            userData.role = role;
            userData.group_id = group_id;
    
            const response = await fetch(`${SERVER_URL}/auth/update_user`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(userData)
            });
    
            const result = await response.json();
            if (result.status === "ok") {
                document.getElementById("userInfo").innerHTML = `
                    <p><b>${userData.name} ${userData.surname}</b></p>
                    <p>Роль: ${userData.role}</p>
                    <p>ВУЗ: ${userData.univer}</p>
                    <p>Группа: ${result.group_number}</p>`;
                nextStep(3);
            } else {
                document.getElementById("error").innerText = "Ошибка при сохранении данных.";
            }
        }
    </script>

</body>
</html>
